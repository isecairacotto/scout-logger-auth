<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scout Logger</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#13294B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<style>
  :root{
    --red:#D22630; --navy:#13294B; --bg:#f7f7fb; --ink:#1f2430; --muted:#6d7280;
    --card:#ffffff; --border:#e6e6ef; --ok:#198754; --warn:#c27d0e;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:2px solid var(--red);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand h1{font-size:18px;margin:0;color:var(--navy);letter-spacing:.3px}
  .logo img{height:28px;width:auto;display:block}
  main{padding:14px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  @media(min-width:760px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 1px 1px rgba(0,0,0,.03)}
  .card h2{font-size:14px;color:var(--navy);margin:0 0 10px 0;text-transform:uppercase;letter-spacing:.08em}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="password"],select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:16px}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg button{flex:1 1 auto;min-width:84px;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;background:#fff;font-weight:600}
  .seg button.active{border-color:var(--navy);color:#fff;background:var(--navy)}
  .seg.sm button{min-width:70px;padding:9px 10px;font-size:14px}
  .slider-wrap{display:flex;align-items:center;gap:10px}
  input[type="range"]{flex:1}
  .badge-input{width:66px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:6px 8px;background:#fff;font-weight:700;font-size:14px}
  .primary{background:var(--red);color:#fff;border:none;border-radius:12px;padding:14px 16px;font-size:16px;font-weight:800;cursor:pointer}
  .secondary{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:16px;font-weight:700;cursor:pointer}
  .ghost{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:14px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
  th{background:#f3f5fa;text-align:left;font-weight:700;color:var(--navy);position:sticky;top:0}
  .hint{font-size:12px;color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)}
  .actions-row{display:flex;gap:10px;flex-wrap:wrap} .right{margin-left:auto}
  .cell-input{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  .cell-select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}
  .cell-actions{display:flex;gap:6px}
  .icon-btn{background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px;line-height:0;cursor:pointer}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin:10px 0}
  .tab{padding:10px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
  .tab.active{background:#f3f5fa;color:var(--navy);font-weight:800}
  .hidden{display:none}
  .success{padding:10px 12px;border:1px solid #c9ebd6;background:#effaf4;color:#136b3c;border-radius:10px}
  /* DSP */
  #eventSection{display:none}
  .toggle{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .toggle.active{background:#eef6ff;border-color:#cfe4ff}
  .checklist{display:none;margin-top:8px;padding:10px;border:1px dashed var(--border);border-radius:10px;background:#fcfcff}
  .checklist.show{display:block}
  .team-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px}
  .team-chip{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:13px}
  @media(max-width:600px){ .team-grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
</style>
</head>
<body>
  <header>
    <div class="brand"><h1>Scout Logger</h1></div>
    <div id="topbar" class="hint"></div>
  </header>

  <main class="grid">
    <!-- LOGIN -->
    <section id="view-login" class="card">
      <h2>Login</h2>
      <div class="grid cols-2">
        <div><label>Username</label><input id="loginUser" type="text" placeholder="username" autocomplete="username" /></div>
        <div><label>Password</label><input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="loginBtn" class="primary">Sign in</button>
        <span id="loginMsg" class="hint"></span>
      </div>
    </section>

    <!-- SCOUT -->
    <section id="view-scout" class="hidden">
      <div class="card">
        <div class="row">
          <div id="whoami" class="hint"></div>
          <div class="right"><button id="logout1" class="ghost">Logout</button></div>
        </div>
        <div class="tabs" id="scoutTabs">
          <div class="tab active" data-tab="history">History</div>
          <div class="tab" data-tab="new">New Event</div>
        </div>
      </div>

      <!-- History -->
      <section id="scout-history" class="card">
  <h2>History</h2>
  <div class="row" style="margin-bottom:6px">
    <span class="hint">Saved workouts (on this device).</span>
    <div class="right">
      <!-- All-events CSV -->
      <button class="ghost" id="exportAllCsvBtn">Download All CSV</button>
    </div>
  </div>

  <table id="eventsTable">
    <thead>
      <tr>
        <th>Date</th><th>Event</th><th>Location</th><th>Scout</th><th>Pitches</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="6" class="hint">No events yet.</td></tr>
    </tbody>
  </table>
</section>

      <!-- New Event (YOUR EXACT LAYOUT) -->
      <section id="scout-new" class="card hidden">
        <h2>Create Player</h2>
        <div class="grid cols-2">
          <div>
            <label>Last, First</label>
            <input id="playerName" type="text" placeholder="Doe, Jane" autocomplete="off" />
          </div>
          <div>
            <label>Role</label>
            <div class="seg sm" id="roleSeg">
              <button type="button" data-role="batter">Batter</button>
              <button type="button" data-role="dual">Dual</button>
              <button type="button" data-role="pitcher">Pitcher</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" id="addPlayerBtn">Add Player</button>
          <span class="hint">Names in dropdowns are sorted A→Z by “Last, First”.</span>
        </div>

        <div style="height:8px"></div>
        <h2>Select Participants</h2>
        <div class="grid cols-2">
          <div><label>Pitcher</label><select id="pitcherSelect"></select></div>
          <div><label>Hitter</label><select id="batterSelect"></select></div>
        </div>

        <div style="height:8px"></div>
        <h2>Pitch Details</h2>
        <label>Zone</label>
        <div class="seg sm" id="zoneSeg">
          <button type="button" data-val="IN">IN</button>
          <button type="button" data-val="OUT">OUT</button>
        </div>

        <div style="height:10px"></div>
        <label>Action</label>
        <div class="seg sm" id="actionSeg">
          <button type="button" data-val="TAKE">Take</button>
          <button type="button" data-val="S/M">S/M</button>
          <button type="button" data-val="FOUL">Foul</button>
          <button type="button" data-val="BIP">BIP</button>
          <button type="button" data-val="HBP">HBP</button>
        </div>

        <div style="height:10px"></div>
        <label>Pitch Type</label>
        <div class="seg sm" id="pitchTypeSeg">
          <button type="button" data-val="FB">FB</button>
          <button type="button" data-val="CB">CB</button>
          <button type="button" data-val="SL">SL</button>
          <button type="button" data-val="CH">CH</button>
          <button type="button" data-val="SF">SF</button>
          <button type="button" data-val="SI">SI</button>
          <button type="button" data-val="OTHER">OTHER</button>
        </div>

        <div style="height:10px"></div>
        <div class="grid cols-2">
          <div>
            <label>Velo (mph) — slide or type, blank/NA=NA</label>
            <div class="slider-wrap">
              <input id="velo" type="range" min="0" max="105" value="0" />
              <input id="veloBox" type="text" class="badge-input" placeholder="NA" inputmode="numeric" aria-label="Velocity value" />
            </div>
          </div>
          <div>
            <label>Spin (rpm) — slide or type, blank/NA=NA</label>
            <div class="slider-wrap">
              <input id="spin" type="range" min="0" max="4000" value="0" />
              <input id="spinBox" type="text" class="badge-input" placeholder="NA" inputmode="numeric" aria-label="Spin rate value" />
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="actions-row">
          <button class="secondary" id="missPitchBtn" title="Logs row with blanks">Miss Pitch</button>
          <div class="right"></div>
          <button class="primary" id="submitPitchBtn">Submit Pitch</button>
        </div>
        <div class="hint" style="margin-top:6px">After each submission, all pitch details reset to unselected and NA.</div>

        <div style="height:12px"></div>
        <h2>Logged Pitches</h2>
        <div class="row" style="margin-bottom:6px"><span class="hint" id="countHint">0 pitches</span></div>
        <div style="overflow:auto;max-height:55vh;margin-top:8px">
          <table id="pitchTable">
            <thead>
              <tr>
                <th>Time</th><th>Pitcher</th><th>Hitter</th><th>Zone</th><th>Action</th><th>Pitch Type</th><th>Velo</th><th>Spin</th><th>Edit</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:10px">
            <div class="right"><button class="ghost" id="submitEventOpenBtn">Submit Event</button></div>
          </div>
        </div>

        <!-- Submit Event Panel -->
        <section id="eventSection" class="card" style="margin-top:10px">
          <h2>Submit Event</h2>
          <div class="grid cols-2">
            <div><label>Date (MM/DD/YYYY)</label><input id="eventDate" type="text" readonly /></div>
            <div><label>Scout Name</label><input id="scoutName" type="text" placeholder="Type your name" /></div>
            <div><label>Event Name</label><input id="eventName" type="text" placeholder="e.g., Perfect Game 17U" /></div>
            <div><label>Location</label><input id="eventLocation" type="text" placeholder="City, ST / Complex" /></div>
          </div>

          <div style="height:10px"></div>
          <div>
            <div class="row"><label>DSP?</label><button type="button" id="dspToggle" class="toggle" aria-pressed="false">No</button></div>
            <div id="dspChecklist" class="checklist">
              <label><input type="checkbox" id="ckBlast"> Blast</label>
              <div class="team-input" id="blastTeamWrap" style="display:none;">
                <label>Which team(s) (Blast)</label>
                <div id="blastTeams" class="team-grid"></div>
              </div>
              <label><input type="checkbox" id="ckTrackman"> Trackman</label>
              <div class="team-input" id="trackmanTeamWrap" style="display:none;">
                <label>Which team(s) (Trackman)</label>
                <div id="trackmanTeams" class="team-grid"></div>
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="actions-row"><div class="right"></div><button class="primary" id="finalSubmitBtn">Submit Event</button></div>
          <div id="eventMsg" style="margin-top:10px"></div>
        </section>
      </section>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="hidden">
      <div class="card">
        <div class="row">
          <div id="adminWhoami" class="hint"></div>
          <div class="right"><button id="logout2" class="ghost">Logout</button></div>
        </div>
        <div class="tabs">
          <div class="tab active" id="adminScoutsTab">Scouts</div>
          <div class="tab" id="adminNewTab">New Event</div>
        </div>
      </div>

      <section id="adminScoutsView" class="card">
        <h2>Scouts</h2>
        <div class="row" style="margin:10px 0">
          <label>Select Scout</label>
          <select id="adminScoutSelect" style="min-width:220px;margin-left:8px"></select>
          <button class="ghost" id="adminExportAllBtn" type="button" style="margin-left:8px">Download All CSV (Selected)</button>
        </div>
        <table id="adminEventsTable">
          <thead><tr><th>Date</th><th>Event</th><th>Location</th><th>Scout</th><th>Pitches</th><th>Actions</th></tr></thead>
        <tbody><tr><td colspan="6" class="hint">Pick a scout to view their local history.</td></tr></tbody>
        </table>
      </section>

      <section id="adminNewView" class="card hidden">
        <h2>New Event</h2>
        <div class="hint">Admins use the same New Event form. Opening it for you now…</div>
      </section>
    </section>
  </main>

  <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="ico-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42L18.37 3.29a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.83z"/></symbol>
    <symbol id="ico-check" viewBox="0 0 24 24"><path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></symbol>
    <symbol id="ico-x" viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.17 12 2.89 5.71 4.3 4.29 10.59 10.6l6.3-6.3z"/></symbol>
  </svg>

<script src="/db.js"></script>

<script>
(function(){

  // ---------- Service Worker (PWA) ----------
  if ('serviceWorker' in navigator) {
    // Registers your real SW file at the site root
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }

  const API = '';

  // ---------- DOM ----------
  const vLogin = document.getElementById('view-login');
  const vScout = document.getElementById('view-scout');
  const vAdmin = document.getElementById('view-admin');

  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const loginBtn  = document.getElementById('loginBtn');
  const loginMsg  = document.getElementById('loginMsg');

  const whoami = document.getElementById('whoami');
  const adminWhoami = document.getElementById('adminWhoami');
  const logout1 = document.getElementById('logout1');
  const logout2 = document.getElementById('logout2');

  const scoutTabs = document.getElementById('scoutTabs');
  const panelHistory = document.getElementById('scout-history');
  const panelNew = document.getElementById('scout-new');

  const eventsTableBody = document.querySelector('#eventsTable tbody');
  const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');

  // New Event elements (your UI)
  const roleSeg=document.getElementById('roleSeg'), zoneSeg=document.getElementById('zoneSeg'), actionSeg=document.getElementById('actionSeg'), pitchTypeSeg=document.getElementById('pitchTypeSeg');
  const addPlayerBtn=document.getElementById('addPlayerBtn'), playerNameInput=document.getElementById('playerName'), pitcherSelect=document.getElementById('pitcherSelect'), batterSelect=document.getElementById('batterSelect');
  const velo=document.getElementById('velo'), spin=document.getElementById('spin'), veloBox=document.getElementById('veloBox'), spinBox=document.getElementById('spinBox');
  const submitPitchBtn=document.getElementById('submitPitchBtn'), missPitchBtn=document.getElementById('missPitchBtn'), pitchTableBody=document.querySelector('#pitchTable tbody'), countHint=document.getElementById('countHint');
  const submitEventOpenBtn=document.getElementById('submitEventOpenBtn'), eventSection=document.getElementById('eventSection');
  const eventDate=document.getElementById('eventDate'), scoutName=document.getElementById('scoutName'), eventName=document.getElementById('eventName'), eventLocation=document.getElementById('eventLocation');
  const dspToggle=document.getElementById('dspToggle'), dspChecklist=document.getElementById('dspChecklist'), finalSubmitBtn=document.getElementById('finalSubmitBtn'), eventMsg=document.getElementById('eventMsg');
  const ckBlast=document.getElementById('ckBlast'), ckTrackman=document.getElementById('ckTrackman');
  const blastTeamWrap=document.getElementById('blastTeamWrap'), trackmanTeamWrap=document.getElementById('trackmanTeamWrap');
  const blastTeams=document.getElementById('blastTeams'), trackmanTeams=document.getElementById('trackmanTeams');

  // Admin
  const adminScoutsTab = document.getElementById('adminScoutsTab');
  const adminNewTab    = document.getElementById('adminNewTab');
  const adminScoutsView= document.getElementById('adminScoutsView');
  const adminNewView   = document.getElementById('adminNewView');
  const adminScoutSelect = document.getElementById('adminScoutSelect');
  const adminEventsTableBody = document.querySelector('#adminEventsTable tbody');
  const adminExportAllBtn = document.getElementById('adminExportAllBtn');

  const topbar = document.getElementById('topbar');

  // ---------- Session & Storage ----------
  function saveSession(s){ localStorage.setItem('session', JSON.stringify(s)); }
  function loadSession(){ try { return JSON.parse(localStorage.getItem('session')) } catch { return null } }
  function clearSession(){ localStorage.removeItem('session'); }
  function show(view){ vLogin.classList.add('hidden'); vScout.classList.add('hidden'); vAdmin.classList.add('hidden'); view.classList.remove('hidden'); }

  function getUser(){ try { return JSON.parse(localStorage.getItem('session'))?.username || 'guest'; } catch { return 'guest'; } }
  function keyPlayers(u){ return `players_${u}` }
  function keyPitches(u){ return `pitches_${u}` } // working set
  function keyEvents(u){  return `events_${u}` }  // saved events

  // ---------- CSV ----------
  function toCSV(rows, headers){
    const esc = v => { if (v == null) return ''; const s = String(v); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; };
    const head = headers.join(',');
    const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
    return head + '\n' + body;
  }
  function download(filename, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
  }

  // ---------- Login ----------
  async function login(){
    loginMsg.textContent = '';
    const username = loginUser.value.trim();
    const password = loginPass.value.trim();
    if(!username || !password){ loginMsg.textContent = 'Enter username and password'; return; }
    try{
      const res = await fetch(API + '/api/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username, password }) });
      if(!res.ok){ loginMsg.textContent = 'Invalid credentials'; return; }
      const data = await res.json();
      saveSession({ token: data.token, role: data.role, fullName: data.fullName, username });
      routeByRole();
    }catch{ loginMsg.textContent = 'Network error'; }
  }
  function routeByRole(){
    const s = loadSession();
    if(!s){ show(vLogin); topbar.textContent=''; return; }
     loggerBooted = false;
    if(s.role === 'admin'){
      adminWhoami.textContent = `Signed in as ${s.fullName} (admin)`;
      topbar.textContent = `${s.fullName} — Admin`;
      show(vAdmin);
      initAdminUI();
      // default to Scouts tab
      adminScoutsTab.classList.add('active'); adminNewTab.classList.remove('active');
      adminScoutsView.classList.remove('hidden'); adminNewView.classList.add('hidden');
    } else {
      whoami.textContent = `Signed in as ${s.fullName}`;
      topbar.textContent = `${s.fullName}`;
      show(vScout);
      // default to History tab
      document.querySelector('[data-tab="history"]').click();
    }
  }
  loginBtn.addEventListener('click', login);
  loginUser.addEventListener('keydown', e=>{ if(e.key==='Enter') login(); });
  loginPass.addEventListener('keydown', e=>{ if(e.key==='Enter') login(); });
  logout1.addEventListener('click', ()=>{
  clearSession();
  loggerBooted = false;   // reset logger when logging out
  routeByRole();
});

logout2.addEventListener('click', ()=>{
  clearSession();
  loggerBooted = false;   // reset logger when logging out
  routeByRole();
});

  // ---------- Scout Tabs ----------
  scoutTabs.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    scoutTabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    panelHistory.classList.toggle('hidden', tab!=='history');
    panelNew.classList.toggle('hidden', tab!=='new');
    if (tab === 'new') initLoggerOnce();
    if (tab === 'history') renderEventsTable();
  });

  // ---------- Logger (Your UI) ----------
  const MLB_TEAMS = ['ARI','ATH','ATL','BAL','BOS','CHC','CIN','CLE','COL','CWS','DET','HOU','KC','LAA','LAD','MIA','MIL','MIN','NYM','NYY','PHI','PIT','SD','SEA','SF','STL','TB','TEX','TOR','WSH'];
  function todayMDY(){ const d=new Date(); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`; }
  function nowStamp(){ const d=new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function setActive(seg, btn){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); }
  function clearActive(seg){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); }
  function getActiveVal(seg){ const b = seg.querySelector('button.active'); return b ? (b.dataset.val || b.dataset.role) : ''; }
  function addOption(select, text){ const opt=document.createElement('option'); opt.text=text; opt.value=text; select.add(opt); }

  let loggerBooted = false;
  function initLoggerOnce(){
    if (loggerBooted) return; loggerBooted = true;
    const user = getUser();
    const K_PLAYERS = keyPlayers(user), K_PITCHES = keyPitches(user), K_EVENTS = keyEvents(user);

    let players = loadJSON(K_PLAYERS, []);
    let pitches = loadJSON(K_PITCHES, []);

    // Defaults
    roleSeg.querySelector('button[data-role="batter"]').classList.add('active');

    // Segment handlers
    roleSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(roleSeg, e.target); });
    zoneSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(zoneSeg, e.target); });
    actionSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(actionSeg, e.target); });
    pitchTypeSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(pitchTypeSeg, e.target); });

    // Slider sync
    function sliderToBox(){ veloBox.value = (Number(velo.value)===0 ? '' : String(velo.value)); spinBox.value = (Number(spin.value)===0 ? '' : String(spin.value)); }
    function commitVelo(){ const v=veloBox.value.trim(); velo.value = (v===''||v.toUpperCase()==='NA') ? 0 : clamp(parseInt(v)||0,0,105); sliderToBox(); }
    function commitSpin(){ const v=spinBox.value.trim(); spin.value = (v===''||v.toUpperCase()==='NA') ? 0 : clamp(parseInt(v)||0,0,4000); sliderToBox(); }
    velo.addEventListener('input', sliderToBox); spin.addEventListener('input', sliderToBox);
    veloBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commitVelo(); veloBox.blur(); }});
    spinBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commitSpin(); spinBox.blur(); }});
    veloBox.addEventListener('change', commitVelo); spinBox.addEventListener('change', commitSpin);
    sliderToBox();

    // Players
    function refreshSelects(){
      pitcherSelect.innerHTML=''; batterSelect.innerHTML='';
      const pitchers = players.filter(p=>p.role==='pitcher'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const batters  = players.filter(p=>p.role==='batter'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      if(!pitchers.length) addOption(pitcherSelect,'— add a Pitcher —'); pitchers.forEach(n=>addOption(pitcherSelect,n));
      if(!batters.length)  addOption(batterSelect,'— add a Hitter —');  batters.forEach(n=>addOption(batterSelect,n));
    }
    function addPlayer(){ const name=(playerNameInput.value||'').trim(); const role=getActiveVal(roleSeg)||'batter'; if(!name){ alert('Enter "Last, First"'); return; } players.push({name,role}); saveJSON(K_PLAYERS,players); playerNameInput.value=''; refreshSelects(); }
    addPlayerBtn.addEventListener('click', addPlayer);

    // Table
    function renderTable(){
      pitchTableBody.innerHTML='';
      pitches.forEach((r,idx)=>{
        const tr=document.createElement('tr'); tr.dataset.index=idx;
        tr.innerHTML = `
          <td>${r.time||''}</td><td>${r.pitcher||''}</td><td>${r.hitter||''}</td><td>${r.zone||''}</td><td>${r.action||''}</td><td>${r.pitchType||''}</td><td>${r.velo??''}</td><td>${r.spin??''}</td>
          <td><div class="cell-actions">
            <button class="icon-btn edit-btn" title="Edit row"><svg width="18" height="18"><use href="#ico-edit"/></svg></button>
            <button class="icon-btn del-btn" title="Delete pitch"><svg width="18" height="18"><use href="#ico-x"/></svg></button>
          </div></td>`;
        pitchTableBody.appendChild(tr);
      });
      countHint.textContent = `${pitches.length} ${pitches.length===1?'pitch':'pitches'}`;
    }
    function getSelections(){
      const pitcher=pitcherSelect.value, hitter=batterSelect.value;
      if(!pitcher||pitcher.startsWith('—')){ alert('Select a PITCHER.'); return null; }
      if(!hitter ||hitter.startsWith('—')){ alert('Select a HITTER.');  return null; }
      return {pitcher,hitter};
    }
    function resetPitchForm(){ clearActive(zoneSeg); clearActive(actionSeg); clearActive(pitchTypeSeg); velo.value=0; spin.value=0; sliderToBox(); }

    function submitPitch(){
      const sel=getSelections(); if(!sel) return;
      const row={ time:nowStamp(), pitcher:sel.pitcher, hitter:sel.hitter, zone:getActiveVal(zoneSeg)||'', action:getActiveVal(actionSeg)||'', pitchType:getActiveVal(pitchTypeSeg)||'', velo:Number(velo.value)===0?'':Number(velo.value), spin:Number(spin.value)===0?'':Number(spin.value) };
      pitches.push(row); saveJSON(K_PITCHES,pitches); renderTable(); submitPitchBtn.textContent='Logged ✓'; setTimeout(()=> submitPitchBtn.textContent='Submit Pitch',500); resetPitchForm();
    }
    function missPitch(){
      const sel=getSelections(); if(!sel) return;
      const row={ time:nowStamp(), pitcher:sel.pitcher, hitter:sel.hitter, zone:'', action:'', pitchType:'', velo:'', spin:'' };
      pitches.push(row); saveJSON(K_PITCHES,pitches); renderTable(); missPitchBtn.textContent='Miss Logged ✓'; setTimeout(()=> missPitchBtn.textContent='Miss Pitch',500); resetPitchForm();
    }
    submitPitchBtn.addEventListener('click', submitPitch);
    missPitchBtn.addEventListener('click', missPitch);

    // inline edit/delete
    const ACTIONS=['TAKE','S/M','FOUL','BIP','HBP'], PITCH_TYPES=['FB','CB','SL','CH','OTHER','SF','SI'], ZONES=['IN','OUT'];
    function makeSelect(options,val){ const sel=document.createElement('select'); sel.className='cell-select'; const empty=document.createElement('option'); empty.value=''; empty.textContent=''; sel.appendChild(empty); options.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; sel.appendChild(op); }); return sel; }
    function makeInput(val){ const i=document.createElement('input'); i.type='text'; i.className='cell-input'; i.value=(val??''); return i; }
    function makePlayerSelect(list,current){ const sel=document.createElement('select'); sel.className='cell-select'; const set=new Set(list); if(current && !set.has(current)) list=[current,...list]; const empty=document.createElement('option'); empty.value=''; empty.textContent=''; sel.appendChild(empty); list.forEach(name=>{ const op=document.createElement('option'); op.value=name; op.textContent=name; if(name===current) op.selected=true; sel.appendChild(op); }); return sel; }

    pitchTableBody.addEventListener('click', (e)=>{
      const del=e.target.closest('.del-btn');
      if(del){ const tr=e.target.closest('tr'); const idx=Number(tr.dataset.index); if(confirm('Delete this pitch?')){ pitches.splice(idx,1); saveJSON(K_PITCHES,pitches); renderTable(); } return; }
      const btn=e.target.closest('.edit-btn'); if(!btn) return;
      const tr=e.target.closest('tr'); const idx=Number(tr.dataset.index); const r=pitches[idx]; if(tr.classList.contains('editing')) return; tr.classList.add('editing');
      const tds=tr.querySelectorAll('td'); const tdPitcher=tds[1], tdHitter=tds[2], tdZone=tds[3], tdAction=tds[4], tdType=tds[5], tdVelo=tds[6], tdSpin=tds[7], tdEdit=tds[8];
      const pitchers=players.filter(p=>p.role==='pitcher'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const batters=players.filter(p=>p.role==='batter'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const selZone=makeSelect(ZONES,r.zone||''); const selAction=makeSelect(ACTIONS,r.action||''); const selType=makeSelect(PITCH_TYPES,r.pitchType||''); const selPitcher=makePlayerSelect(pitchers,r.pitcher||''); const selHitter=makePlayerSelect(batters,r.hitter||''); const inVelo=makeInput(r.velo); const inSpin=makeInput(r.spin);
      tdPitcher.innerHTML=''; tdPitcher.appendChild(selPitcher);
      tdHitter.innerHTML=''; tdHitter.appendChild(selHitter);
      tdZone.innerHTML=''; tdZone.appendChild(selZone);
      tdAction.innerHTML=''; tdAction.appendChild(selAction);
      tdType.innerHTML=''; tdType.appendChild(selType);
      tdVelo.innerHTML=''; tdVelo.appendChild(inVelo);
      tdSpin.innerHTML=''; tdSpin.appendChild(inSpin);
      tdEdit.innerHTML='';
      const saveBtn=document.createElement('button'); saveBtn.className='icon-btn'; saveBtn.title='Save'; saveBtn.innerHTML='<svg width="18" height="18"><use href="#ico-check"/></svg>';
      const cancelBtn=document.createElement('button'); cancelBtn.className='icon-btn'; cancelBtn.title='Cancel'; cancelBtn.innerHTML='<svg width="18" height="18"><use href="#ico-x"/></svg>';
      tdEdit.appendChild(saveBtn); tdEdit.appendChild(cancelBtn);
      saveBtn.addEventListener('click', ()=>{ r.pitcher=selPitcher.value.trim(); r.hitter=selHitter.value.trim(); r.zone=selZone.value||''; r.action=selAction.value||''; r.pitchType=selType.value||''; r.velo=inVelo.value.trim(); r.spin=inSpin.value.trim(); saveJSON(K_PITCHES,pitches); tr.classList.remove('editing'); renderTable(); });
      cancelBtn.addEventListener('click', ()=>{ tr.classList.remove('editing'); renderTable(); });
    });

    // DSP teams
    function populateTeamChecks(container){
      container.innerHTML='';
      MLB_TEAMS.forEach(t=>{
        const label=document.createElement('label');
        label.className='team-chip';
        const cb=document.createElement('input');
        cb.type='checkbox'; cb.value=t;
        label.appendChild(cb);
        const txt=document.createElement('span'); txt.textContent=t; label.appendChild(txt);
        container.appendChild(label);
      });
    }
    populateTeamChecks(blastTeams);
    populateTeamChecks(trackmanTeams);

    submitEventOpenBtn.addEventListener('click', ()=>{
      eventSection.style.display='block';
      eventDate.value=todayMDY();
      eventMsg.innerHTML='';
      dspToggle.classList.remove('active'); dspToggle.textContent='No'; dspToggle.setAttribute('aria-pressed','false');
      dspChecklist.classList.remove('show');
      ckBlast.checked=false; blastTeamWrap.style.display='none';
      ckTrackman.checked=false; trackmanTeamWrap.style.display='none';
      eventSection.scrollIntoView({behavior:'smooth'});
    });
    dspToggle.addEventListener('click', ()=>{
      const active=dspToggle.classList.toggle('active');
      dspToggle.textContent=active?'Yes':'No';
      dspToggle.setAttribute('aria-pressed', String(active));
      if(active){ dspChecklist.classList.add('show'); } else { dspChecklist.classList.remove('show'); }
    });
    ckBlast.addEventListener('change', e=>{ blastTeamWrap.style.display = e.target.checked ? 'block' : 'none'; });
    ckTrackman.addEventListener('change', e=>{ trackmanTeamWrap.style.display = e.target.checked ? 'block' : 'none'; });

    // Save Event -> History
    function eventCSVRows(event){
      return event.rows.map(r => ({
        date: event.date,
        event: event.name,
        location: event.location,
        scout: event.scout,
        time: r.time,
        pitcher: r.pitcher,
        hitter: r.hitter,
        zone: r.zone,
        action: r.action,
        pitchType: r.pitchType,
        velo: r.velo,
        spin: r.spin
      }));
    }

    finalSubmitBtn.addEventListener('click', ()=>{
      const s = loadSession() || {};
      const user = s.username || 'guest';
      const K_EVENTS = keyEvents(user), K_PITCHES = keyPitches(user), K_PLAYERS = keyPlayers(user);

      const name = (eventName.value||'').trim() || 'Untitled';
      const date = (eventDate.value||todayMDY()).trim();
      const location = (eventLocation.value||'').trim();
      const scout = (scoutName.value||s.fullName||user).trim();

      const rows = loadJSON(K_PITCHES, []);
      if (!rows.length){ eventMsg.innerHTML='<div class="success warn">No pitches to save.</div>'; return; }

      // DSP meta
      const dsp = dspToggle.classList.contains('active');
      const blast = ckBlast.checked ? Array.from(blastTeams.querySelectorAll('input:checked')).map(c=>c.value) : [];
      const trackman = ckTrackman.checked ? Array.from(trackmanTeams.querySelectorAll('input:checked')).map(c=>c.value) : [];

      const evts = loadJSON(K_EVENTS, []);
      evts.push({
        id: Date.now(),
        user,
        name,
        date,
        location,
        scout,
        count: rows.length,
        rows: rows.slice(),
        dsp, blast, trackman
      });
      saveJSON(K_EVENTS, evts);

      // Clear working sets
      saveJSON(K_PITCHES, []);
      saveJSON(K_PLAYERS, []);
      players = []; pitches = [];
      playerNameInput.value=''; eventName.value=''; eventLocation.value=''; scoutName.value='';
      refreshSelects(); renderTable();
      ckBlast.checked=false; blastTeamWrap.style.display='none'; ckTrackman.checked=false; trackmanTeamWrap.style.display='none';
      dspToggle.classList.remove('active'); dspToggle.textContent='No'; dspChecklist.classList.remove('show');
      eventMsg.innerHTML='<div class="success">Event submitted. Saved to History & cleared current log.</div>';
      renderEventsTable();
      setTimeout(()=>{ eventSection.style.display='none'; }, 1200);
    });

    // initial
    refreshSelects(); renderTable();
  }

  // ---------- History rendering + CSV ----------
  function renderEventsTable(){
    const s = loadSession() || {};
    const user = s.username || 'guest';
    const K_EVENTS = keyEvents(user);
    const evts = loadJSON(K_EVENTS, []);
    eventsTableBody.innerHTML = '';
    if (!evts.length){ eventsTableBody.innerHTML = `<tr><td colspan="6" class="hint">No events yet.</td></tr>`; return; }
    evts.sort((a,b)=> b.id - a.id).forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.name}</td>
        <td>${e.location||''}</td>
        <td>${e.scout||''}</td>
        <td>${e.count}</td>
        <td class="cell-actions">
          <button class="ghost" data-action="csv" data-id="${e.id}">CSV</button>
          <button class="ghost" data-action="open" data-id="${e.id}">Open</button>
          <button class="ghost" data-action="del" data-id="${e.id}">Delete</button>
        </td>`;
      eventsTableBody.appendChild(tr);
    });
    eventsTableBody.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        const s = loadSession() || {};
        const user = s.username || 'guest';
        const K_EVENTS = keyEvents(user), K_PITCHES = keyPitches(user);
        const id = Number(b.dataset.id), action = b.dataset.action;
        const list = loadJSON(K_EVENTS, []);
        const idx = list.findIndex(x=>x.id===id);
        if (idx<0) return;
        const e = list[idx];
        if (action==='csv'){
          const headers = ['date','event','location','scout','time','pitcher','hitter','zone','action','pitchType','velo','spin'];
          const rows = e.rows.map(r=>({date:e.date,event:e.name,location:e.location,scout:e.scout,time:r.time,pitcher:r.pitcher,hitter:r.hitter,zone:r.zone,action:r.action,pitchType:r.pitchType,velo:r.velo,spin:r.spin}));
          download(`${e.date} ${e.name}.csv`, toCSV(rows, headers));
        }
        if (action==='open'){
          // load into New Event for editing
          saveJSON(K_PITCHES, e.rows.slice());
          document.querySelector('[data-tab="new"]').click();
          window.scrollTo({top:0,behavior:'smooth'});
        }
        if (action==='del'){
          if (confirm('Delete this event?')){
            list.splice(idx,1); saveJSON(K_EVENTS,list); renderEventsTable();
          }
        }
      });
    });
  }
  exportAllCsvBtn.addEventListener('click', ()=>{
    const s = loadSession() || {};
    const user = s.username || 'guest';
    const K_EVENTS = keyEvents(user);
    const evts = loadJSON(K_EVENTS, []);
    if (!evts.length){ alert('No events to export.'); return; }
    const headers = ['date','event','location','scout','time','pitcher','hitter','zone','action','pitchType','velo','spin'];
    const rows = evts.flatMap(e => e.rows.map(r=>({date:e.date,event:e.name,location:e.location,scout:e.scout,time:r.time,pitcher:r.pitcher,hitter:r.hitter,zone:r.zone,action:r.action,pitchType:r.pitchType,velo:r.velo,spin:r.spin})));
    download(`${user}-all-events.csv`, toCSV(rows, headers));
  });

  // ---------- Admin ----------

  let newEventOriginalParent = null;
function mountNewEventIntoAdmin() {
  const newPanel = document.getElementById('scout-new');
  if (!newPanel) return;
  if (!newEventOriginalParent) newEventOriginalParent = newPanel.parentElement; // remember where it came from
  document.getElementById('adminNewView').appendChild(newPanel);
  newPanel.classList.remove('hidden');
  initLoggerOnce(); // ensure the logger UI is initialized once
}

function unmountNewEventBackToScout() {
  const newPanel = document.getElementById('scout-new');
  if (!newPanel || !newEventOriginalParent) return;
  newEventOriginalParent.appendChild(newPanel);
  newPanel.classList.add('hidden'); // default hidden when not in use under Scout tabs
}
  
  const KNOWN_USERS = [
    "faffanis","malvarez","mberumen","fbreton","scabral","jcabrera","jcalderon","pciriaco","tclaus","jcruz","rcubillan","jdavis","jfitzpatrick","egomez","mgroopman","jhernandez","jkaregeannes","jkim","mlaureano","llin","wlobo","kmatsumoto","emedina","amejia","rmendoza","rmora","cmorillo","rmotooka","enanita","dneuman","cocando","rpino","eramirez","arequena","hrincones","mrodriguez","eromero","rsaggiadi","lsambo","gschilz","czamora","mcuellar","cschneider","isecairacotto"
  ];
  function initAdminUI(){
    // populate list once
    if (!adminScoutSelect.dataset.ready){
      adminScoutSelect.innerHTML=''; const add=(v,t)=>{ const o=document.createElement('option'); o.value=v; o.text=t; adminScoutSelect.add(o); };
      add('', '— select scout —'); KNOWN_USERS.forEach(u=> add(u,u));
      adminScoutSelect.dataset.ready='1';
    }
  }
  function adminListEventsFor(user){
    const evts = loadJSON(keyEvents(user), []);
    adminEventsTableBody.innerHTML='';
    if (!evts.length){
      adminEventsTableBody.innerHTML = `<tr><td colspan="6" class="hint">No local events for ${user}.</td></tr>`;
      return;
    }
    evts.sort((a,b)=> b.id - a.id).forEach(e=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.date}</td>
        <td>${e.name}</td>
        <td>${e.location||''}</td>
        <td>${e.scout||''}</td>
        <td>${e.count}</td>
        <td class="cell-actions">
          <button class="ghost" data-action="csv" data-id="${e.id}">CSV</button>
          <button class="ghost" data-action="open" data-id="${e.id}">Open</button>
          <button class="ghost" data-action="del" data-id="${e.id}">Delete</button>
        </td>`;
      adminEventsTableBody.appendChild(tr);
    });
    adminEventsTableBody.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = Number(b.dataset.id), action=b.dataset.action;
        const list = loadJSON(keyEvents(user), []);
        const idx = list.findIndex(x=>x.id===id); if (idx<0) return;
        const e = list[idx];
        if (action==='csv'){
          const headers = ['date','event','location','scout','time','pitcher','hitter','zone','action','pitchType','velo','spin'];
          const rows = e.rows.map(r=>({date:e.date,event:e.name,location:e.location,scout:e.scout,time:r.time,pitcher:r.pitcher,hitter:r.hitter,zone:r.zone,action:r.action,pitchType:r.pitchType,velo:r.velo,spin:r.spin}));
          download(`${user} - ${e.date} ${e.name}.csv`, toCSV(rows, headers));
        }
        if (action==='del'){
          if (confirm(`Delete ${e.name}?`)){ list.splice(idx,1); saveJSON(keyEvents(user), list); adminListEventsFor(user); }
        }
        if (action==='open'){
          const s = loadSession(); if (!s){ alert('Please log in first.'); return; }
          saveJSON(keyPitches(s.username), e.rows.slice());
          // jump to New Event UI (so admin sees the form, not an empty tab)
          show(vScout);
          adminNewTab.classList.add('active'); 
          adminScoutsTab.classList.remove('active');
          adminScoutsView.classList.add('hidden'); 
          adminNewView.classList.remove('hidden');
          mountNewEventIntoAdmin();
          window.scrollTo({top:0,behavior:'smooth'});
        }
      });
    });
  }
  adminScoutsTab.addEventListener('click', ()=>{
  show(vAdmin); // <-- bring admin shell back if we were in scout view
  adminScoutsTab.classList.add('active'); 
  adminNewTab.classList.remove('active');
  adminScoutsView.classList.remove('hidden'); 
  adminNewView.classList.add('hidden');
  unmountNewEventBackToScout(); // put New Event panel back under the Scout view
});
  adminNewTab.addEventListener('click', ()=>{
  show(vAdmin); // <-- stay inside admin shell
  adminNewTab.classList.add('active'); 
  adminScoutsTab.classList.remove('active');
  adminScoutsView.classList.add('hidden'); 
  adminNewView.classList.remove('hidden');
  mountNewEventIntoAdmin(); // show the same New Event UI inside admin tab
  window.scrollTo({top:0,behavior:'smooth'});
});
  adminScoutSelect.addEventListener('change', ()=>{
    const u = adminScoutSelect.value;
    if (!u) { adminEventsTableBody.innerHTML = `<tr><td colspan="6" class="hint">Pick a scout to view their local history.</td></tr>`; return; }
    adminListEventsFor(u);
  });
  adminExportAllBtn.addEventListener('click', ()=>{
    const u = adminScoutSelect.value; if (!u){ alert('Pick a scout first'); return; }
    const evts = loadJSON(keyEvents(u), []); if (!evts.length){ alert(`No events for ${u}`); return; }
    const headers = ['date','event','location','scout','time','pitcher','hitter','zone','action','pitchType','velo','spin'];
    const rows = evts.flatMap(e => e.rows.map(r=>({date:e.date,event:e.name,location:e.location,scout:e.scout,time:r.time,pitcher:r.pitcher,hitter:r.hitter,zone:r.zone,action:r.action,pitchType:r.pitchType,velo:r.velo,spin:r.spin})));
    download(`${u}-all-events.csv`, toCSV(rows, headers));
  });

  // ---------- Boot ----------
  document.getElementById('topbar').textContent='';
  routeByRole();
})();
</script>
</body>
</html>
</body>
</html>
