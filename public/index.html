<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Scout Logger</title>

<!-- PWA bits -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#13294B">

<style>
  :root{
    --red:#D22630; --navy:#13294B; --bg:#f7f7fb; --ink:#1f2430; --muted:#6d7280;
    --card:#ffffff; --border:#e6e6ef; --ok:#198754; --warn:#c27d0e;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:2px solid var(--red);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
  .brand h1{font-size:18px;margin:0;color:var(--navy);letter-spacing:.3px}
  .logo img{height:28px;width:auto;display:block}
  main{padding:14px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  @media(min-width:760px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 1px 1px rgba(0,0,0,.03)}
  .card h2{font-size:14px;color:var(--navy);margin:0 0 10px 0;text-transform:uppercase;letter-spacing:.08em}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="password"],select{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:16px}
  .seg{display:flex;gap:8px;flex-wrap:wrap}
  .seg button{flex:1 1 auto;min-width:84px;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
  .seg button.active{border-color:var(--navy);color:#fff;background:var(--navy)}
  .seg.sm button{min-width:70px;padding:9px 10px;font-size:14px}
  .slider-wrap{display:flex;align-items:center;gap:10px}
  input[type="range"]{flex:1}
  .badge-input{width:66px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:6px 8px;background:#fff;font-weight:700;font-size:14px}
  .primary{background:var(--red);color:#fff;border:none;border-radius:12px;padding:14px 16px;font-size:16px;font-weight:800;cursor:pointer}
  .secondary{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 16px;font-size:16px;font-weight:700;cursor:pointer}
  .ghost{background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:14px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:middle}
  th{background:#f3f5fa;text-align:left;font-weight:700;color:var(--navy);position:sticky;top:0}
  .hint{font-size:12px;color:var(--muted)} .ok{color:var(--ok)} .warn{color:var(--warn)}
  .actions-row{display:flex;gap:10px;flex-wrap:wrap} .right{margin-left:auto}
  .cell-input{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;font-size:14px}
  .cell-select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff}
  .cell-actions{display:flex;gap:6px}
  .icon-btn{background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px;line-height:0;cursor:pointer}
  .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border);margin:10px 0}
  .tab{padding:10px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#fff;cursor:pointer}
  .tab.active{background:#f3f5fa;color:var(--navy);font-weight:800}
  .hidden{display:none}
  .success{padding:10px 12px;border:1px solid #c9ebd6;background:#effaf4;color:#136b3c;border-radius:10px}
</style>
</head>
<body>
  <header>
    <div class="brand"><h1>Scout Logger</h1></div>
    <div class="hint" id="netBadge"></div>
  </header>

  <main class="grid">
    <!-- LOGIN -->
    <section id="view-login" class="card">
      <h2>Login</h2>
      <div class="grid cols-2">
        <div>
          <label>Username</label>
          <input id="loginUser" type="text" placeholder="username" autocomplete="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="loginBtn" class="primary" type="button">Sign in</button>
        <button id="offlineBtn" class="ghost" type="button">Continue Offline</button>
        <span id="loginMsg" class="hint"></span>
      </div>
    </section>

    <!-- SCOUT HOME -->
    <section id="view-scout" class="card hidden">
      <div class="row">
        <div id="whoami" class="hint"></div>
        <div class="right"><button id="logout1" class="ghost" type="button">Logout</button></div>
      </div>

      <div class="tabs" id="scoutTabs">
        <div class="tab active" data-tab="history">History</div>
        <div class="tab" data-tab="new">New Event</div>
      </div>

      <!-- Scout History -->
      <div id="scout-history">
        <div class="row" style="margin-bottom:6px">
          <span class="hint">Your submitted events</span>
          <div class="right"><button id="scoutRefresh" class="ghost" type="button">Refresh</button></div>
        </div>
        <table id="scoutEventsTable">
          <thead><tr><th>Date</th><th>Name</th><th>Location</th><th>Pitches</th><th>CSV</th></tr></thead>
          <tbody><tr><td colspan="5" class="hint">No events yet.</td></tr></tbody>
        </table>
      </div>

      <!-- Scout New Event -->
      <div id="scout-new" class="hidden">
        <!-- Create Player -->
        <section class="card" style="margin-top:10px">
          <h2>Create Player</h2>
          <div class="grid cols-2">
            <div>
              <label>Last, First</label>
              <input id="playerName" type="text" placeholder="Doe, Jane" autocomplete="off" />
            </div>
            <div>
              <label>Role</label>
              <div class="seg sm" id="roleSeg">
                <button type="button" data-role="batter">Batter</button>
                <button type="button" data-role="dual">Dual</button>
                <button type="button" data-role="pitcher">Pitcher</button>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="ghost" id="addPlayerBtn">Add Player</button>
            <span class="hint">Names in dropdowns are sorted A→Z by “Last, First”.</span>
          </div>
        </section>

        <!-- Select Participants -->
        <section class="card" style="margin-top:10px">
          <h2>Select Participants</h2>
          <div class="grid cols-2">
            <div>
              <label>Pitcher</label>
              <select id="pitcherSelect"></select>
            </div>
            <div>
              <label>Hitter</label>
              <select id="batterSelect"></select>
            </div>
          </div>
        </section>

        <!-- Pitch Details -->
        <section class="card" style="margin-top:10px">
          <h2>Pitch Details</h2>
          <label>Zone</label>
          <div class="seg sm" id="zoneSeg">
            <button type="button" data-val="IN">IN</button>
            <button type="button" data-val="OUT">OUT</button>
          </div>

          <div style="height:10px"></div>
          <label>Action</label>
          <div class="seg sm" id="actionSeg">
            <button type="button" data-val="TAKE">Take</button>
            <button type="button" data-val="S/M">S/M</button>
            <button type="button" data-val="FOUL">Foul</button>
            <button type="button" data-val="BIP">BIP</button>
            <button type="button" data-val="HBP">HBP</button>
          </div>

          <div style="height:10px"></div>
          <label>Pitch Type</label>
          <div class="seg sm" id="pitchTypeSeg">
            <button type="button" data-val="FB">FB</button>
            <button type="button" data-val="CB">CB</button>
            <button type="button" data-val="SL">SL</button>
            <button type="button" data-val="CH">CH</button>
            <button type="button" data-val="SF">SF</button>
            <button type="button" data-val="SI">SI</button>
            <button type="button" data-val="OTHER">OTHER</button>
          </div>

          <div style="height:10px"></div>
          <div class="grid cols-2">
            <div>
              <label>Velo (mph) — slide or type, blank/NA=NA</label>
              <div class="slider-wrap">
                <input id="velo" type="range" min="0" max="105" value="0" />
                <input id="veloBox" type="text" class="badge-input" placeholder="NA" inputmode="numeric" aria-label="Velocity value" />
              </div>
            </div>
            <div>
              <label>Spin (rpm) — slide or type, blank/NA=NA</label>
              <div class="slider-wrap">
                <input id="spin" type="range" min="0" max="4000" value="0" />
                <input id="spinBox" type="text" class="badge-input" placeholder="NA" inputmode="numeric" aria-label="Spin rate value" />
              </div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div class="actions-row">
            <button class="secondary" id="missPitchBtn" title="Logs a row with blanks (except players & timestamp).">Miss Pitch</button>
            <div class="right"></div>
            <button class="primary" id="submitPitchBtn">Submit Pitch</button>
          </div>
          <div class="hint" style="margin-top:6px">After each submission, all pitch details reset to unselected and NA.</div>
        </section>

        <!-- Logged Pitches -->
        <section class="card" style="margin-top:10px">
          <h2>Logged Pitches</h2>
          <div class="row" style="margin-bottom:6px"><span class="hint" id="countHint">0 pitches</span></div>
          <div style="overflow:auto;max-height:55vh;margin-top:8px">
            <table id="pitchTable">
              <thead>
                <tr>
                  <th>Time</th><th>Pitcher</th><th>Hitter</th><th>Zone</th><th>Action</th><th>Pitch Type</th><th>Velo</th><th>Spin</th><th>Edit</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="row" style="margin-top:10px">
              <div class="right"><button class="ghost" id="submitEventOpenBtn">Submit Event</button></div>
            </div>
          </div>
        </section>

        <!-- Submit Event panel -->
        <section id="eventSection" class="card hidden">
          <h2>Submit Event</h2>
          <div class="grid cols-2">
            <div><label>Date (MM/DD/YYYY)</label><input id="eventDate" type="text" readonly /></div>
            <div><label>Scout Name</label><input id="scoutName" type="text" placeholder="Type your name" /></div>
            <div><label>Event Name</label><input id="eventName" type="text" placeholder="e.g., Perfect Game 17U" /></div>
            <div><label>Location</label><input id="eventLocation" type="text" placeholder="City, ST / Complex" /></div>
          </div>
          <div style="height:12px"></div>
          <div class="actions-row"><div class="right"></div><button class="primary" id="finalSubmitBtn">Submit Event</button></div>
          <div id="eventMsg" style="margin-top:10px"></div>
        </section>
      </div>
    </section>

    <!-- ADMIN HOME -->
    <section id="view-admin" class="card hidden">
      <div class="row">
        <div id="adminWhoami" class="hint"></div>
        <div class="right"><button id="logout2" class="ghost" type="button">Logout</button></div>
      </div>

      <div class="tabs" id="adminTabs">
        <div class="tab active" data-tab="scouts">Scouts</div>
        <div class="tab" data-tab="new">New Event</div>
      </div>

      <!-- Admin: scout list + history -->
      <div id="admin-scouts">
        <div class="grid cols-2">
          <section class="card">
            <h2>Scouts</h2>
            <label for="scoutPicker">Select Scout</label>
            <select id="scoutPicker"></select>
          </section>

          <section class="card">
            <h2>Selected Scout</h2>
            <div class="row" style="margin-bottom:6px">
              <span class="hint" id="selScoutHint">No scout selected.</span>
              <div class="right"><button id="adminRefresh" class="ghost" type="button">Refresh</button></div>
            </div>
            <table id="adminEventsTable">
              <thead><tr><th>Date</th><th>Name</th><th>Location</th><th>Pitches</th><th>CSV</th></tr></thead>
              <tbody><tr><td colspan="5" class="hint">Pick a scout to view events.</td></tr></tbody>
            </table>
          </section>
        </div>
      </div>

      <!-- Admin: New Event (same logger UI) -->
      <div id="admin-new" class="hidden">
        <div class="row" style="margin-bottom:8px">
          <button id="backToAdminBtn" class="ghost" type="button">← Back to Admin</button>
        </div>
        <!-- Reuse the same logger DOM by mounting below -->
        <div id="adminLoggerMount"></div>
      </div>
    </section>
  </main>

  <!-- icons -->
  <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
    <symbol id="ico-edit" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42L18.37 3.29a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.83z"/></symbol>
    <symbol id="ico-check" viewBox="0 0 24 24"><path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></symbol>
    <symbol id="ico-x" viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.3 19.71 2.89 18.3 9.17 12 2.89 5.71 4.3 4.29 10.59 10.6l6.3-6.3z"/></symbol>
  </svg>

<script>
(function(){
  // PWA: register service worker for offline shell
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
  }

  // ---- helpers
  const API = ''; // same-origin
  const $ = (sel) => document.querySelector(sel);
  const byId = (id) => document.getElementById(id);

  function saveSession(s){ localStorage.setItem('session', JSON.stringify(s)); }
  function loadSession(){ try { return JSON.parse(localStorage.getItem('session')) } catch { return null } }
  function clearSession(){ localStorage.removeItem('session'); }

  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k,fb){ try{ return JSON.parse(localStorage.getItem(k)) ?? fb; } catch{ return fb; } }

  function todayMDY(){ const d=new Date(); return `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`; }
  function nowStamp(){ const d=new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }
  function setNetBadge(){ byId('netBadge').textContent = navigator.onLine ? 'Online' : 'Offline'; }
  window.addEventListener('online', setNetBadge); window.addEventListener('offline', setNetBadge); setNetBadge();

  // ---- views
  const vLogin = byId('view-login');
  const vScout = byId('view-scout');
  const vAdmin = byId('view-admin');

  function show(view){
    vLogin.classList.add('hidden');
    vScout.classList.add('hidden');
    vAdmin.classList.add('hidden');
    view.classList.remove('hidden');
  }

  // ---- login elements
  const loginUser = byId('loginUser');
  const loginPass = byId('loginPass');
  const loginBtn  = byId('loginBtn');
  const offlineBtn= byId('offlineBtn');
  const loginMsg  = byId('loginMsg');

  // ---- common UI
  const whoami = byId('whoami');
  const adminWhoami = byId('adminWhoami');
  const logout1 = byId('logout1');
  const logout2 = byId('logout2');

  // ---- SCOUT tabs
  const scoutTabs = byId('scoutTabs');
  const panelHistory = byId('scout-history');
  const panelNew = byId('scout-new');
  const scoutEventsTable = byId('scoutEventsTable');
  const scoutRefresh = byId('scoutRefresh');

  // ---- ADMIN tabs
  const adminTabs = byId('adminTabs');
  const adminScouts = byId('admin-scouts');
  const adminNew = byId('admin-new');
  const backToAdminBtn = byId('backToAdminBtn');
  const scoutPicker = byId('scoutPicker');
  const selScoutHint = byId('selScoutHint');
  const adminEventsTable = byId('adminEventsTable');
  const adminRefresh = byId('adminRefresh');

  // ---------- per-user storage keys ----------
  function keysFor(user){
    return {
      players: `players_${user}`,
      pitches: `pitches_${user}`,
      events:  `events_${user}` // array of submitted events
    };
  }

  // ---------- LOGIN ----------
  async function login(){
    loginMsg.textContent = '';
    const username = (loginUser.value||'').trim();
    const password = (loginPass.value||'').trim();
    if(!username || !password){ loginMsg.textContent='Enter username and password'; return; }

    try{
      const res = await fetch(API + '/api/login', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ username, password })
      });
      if(!res.ok){ loginMsg.textContent='Invalid credentials'; return; }
      const data = await res.json(); // { token, fullName, role }
      saveSession({ token: data.token, role: data.role, fullName: data.fullName, username });
      routeByRole(true);
    }catch(err){
      console.error(err);
      loginMsg.textContent = 'Network error';
    }
  }

  function routeByRole(resetLogger){
    const s = loadSession();
    if(!s){ show(vLogin); return; }
    if(resetLogger) loggerBooted = false; // ensure fresh logger on user change
    if(s.role === 'admin'){
      adminWhoami.textContent = `Signed in as ${s.fullName} (admin)`;
      populateScoutPicker();
      show(vAdmin);
    } else {
      whoami.textContent = `Signed in as ${s.fullName}`;
      renderScoutEvents();
      show(vScout);
    }
  }

  loginBtn.addEventListener('click', login);
  loginUser.addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });
  loginPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });

  // Offline continue: use last saved session without hitting /api
  offlineBtn.addEventListener('click', ()=>{
    const s = loadSession();
    if(!s){ loginMsg.textContent='No prior session found on this device.'; return; }
    routeByRole(false);
  });

  logout1.addEventListener('click', ()=>{ clearSession(); show(vLogin); });
  logout2.addEventListener('click', ()=>{ clearSession(); show(vLogin); });

  // ---------- SCOUT: tabs + history ----------
  scoutTabs.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    const s = loadSession();
    const tab = t.dataset.tab;

    // If ADMIN somehow clicks Scout tabs (from shared logger), go back to Admin view
    if (s?.role === 'admin' && tab === 'history') { show(vAdmin); return; }

    scoutTabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    panelHistory.classList.toggle('hidden', tab!=='history');
    panelNew.classList.toggle('hidden', tab!=='new');
    if (tab === 'new') initLoggerOnce(); // boot logger when opening
  });

  function renderScoutEvents(){
    const s = loadSession(); if(!s) return;
    const KS = keysFor(s.username);
    const events = load(KS.events, []);
    const tb = scoutEventsTable.querySelector('tbody');
    tb.innerHTML = '';
    if(!events.length){
      const tr=document.createElement('tr'); tr.innerHTML='<td colspan="5" class="hint">No events yet.</td>'; tb.appendChild(tr); return;
    }
    events.forEach(ev=>{
      const tr = document.createElement('tr');
      const pitchCount = ev.pitches?.length || 0;
      tr.innerHTML = `
        <td>${ev.date||''}</td>
        <td>${ev.name||''}</td>
        <td>${ev.location||''}</td>
        <td>${pitchCount}</td>
        <td><button class="ghost" data-csv="${ev.id}">Download CSV</button></td>
      `;
      tb.appendChild(tr);
    });
    // hook CSV buttons
    tb.querySelectorAll('button[data-csv]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-csv');
        const s = loadSession(); const KS = keysFor(s.username);
        const events = load(KS.events, []);
        const ev = events.find(e => String(e.id) === String(id));
        if(!ev) return;
        downloadEventCSV(ev);
      });
    });
  }
  scoutRefresh.addEventListener('click', renderScoutEvents);

  // ---------- ADMIN: tabs + scout picker + events ----------
  adminTabs.addEventListener('click', (e)=>{
    const t = e.target.closest('.tab'); if(!t) return;
    adminTabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    adminScouts.classList.toggle('hidden', tab!=='scouts');
    adminNew.classList.toggle('hidden', tab!=='new');
    if (tab === 'new') { initLoggerOnce(true); } // admin logger
  });

  backToAdminBtn.addEventListener('click', ()=> show(vAdmin));

  // Static list of usernames (from your server list) to populate picker
  const ALL_SCOUT_USERNAMES = [
    "faffanis","malvarez","mberumen","fbreton","scabral","jcabrera","jcalderon","pciriaco","tclaus","jcruz","rcubillan","jdavis","jfitzpatrick","egomez","mgroopman","jhernandez","jkaregeannes","jkim","mlaureano","llin","wlobo","kmatsumoto","emedina","amejia","rmendoza","rmora","cmorillo","rmotooka","enanita","dneuman","cocando","rpino","eramirez","arequena","hrincones","mrodriguez","eromero","rsaggiadi","lsambo","gschilz","czamora",
    // admins
    "mcuellar","jfitzpatrick","cschneider","isecairacotto"
  ];

  function populateScoutPicker(){
    scoutPicker.innerHTML='';
    const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='— Select a scout —'; scoutPicker.appendChild(opt0);
    ALL_SCOUT_USERNAMES.sort().forEach(u=>{
      const o=document.createElement('option'); o.value=u; o.textContent=u; scoutPicker.appendChild(o);
    });
    selScoutHint.textContent = 'No scout selected.';
    adminEventsTable.querySelector('tbody').innerHTML = '<tr><td colspan="5" class="hint">Pick a scout to view events.</td></tr>';
  }

  function renderAdminScoutEvents(username){
    const KS = keysFor(username);
    const events = load(KS.events, []);
    selScoutHint.textContent = `Viewing ${username} — ${events.length} event${events.length===1?'':'s'}`;
    const tb = adminEventsTable.querySelector('tbody');
    tb.innerHTML='';
    if(!events.length){ tb.innerHTML='<tr><td colspan="5" class="hint">No events for this scout.</td></tr>'; return; }
    events.forEach(ev=>{
      const tr = document.createElement('tr');
      const pitchCount = ev.pitches?.length || 0;
      tr.innerHTML = `
        <td>${ev.date||''}</td>
        <td>${ev.name||''}</td>
        <td>${ev.location||''}</td>
        <td>${pitchCount}</td>
        <td><button class="ghost" data-csv="${ev.id}" data-user="${username}">Download CSV</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('button[data-csv]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-csv');
        const user = btn.getAttribute('data-user');
        const KS2 = keysFor(user);
        const events2 = load(KS2.events, []);
        const ev = events2.find(e => String(e.id) === String(id));
        if(!ev) return;
        downloadEventCSV(ev);
      });
    });
  }

  scoutPicker.addEventListener('change', ()=>{
    const u = scoutPicker.value;
    if(!u){ selScoutHint.textContent='No scout selected.'; adminEventsTable.querySelector('tbody').innerHTML='<tr><td colspan="5" class="hint">Pick a scout to view events.</td></tr>'; return; }
    renderAdminScoutEvents(u);
  });
  adminRefresh.addEventListener('click', ()=>{ const u=scoutPicker.value; if(u) renderAdminScoutEvents(u); });

  // ---------- LOGGER (mounts in Scout New and Admin New) ----------
  let loggerBooted = false;

  function initLoggerOnce(forAdmin=false){
    if(loggerBooted) return;
    loggerBooted = true;

    const session = loadSession() || {};
    const user = session?.username || 'guest';
    const KS = keysFor(user);

    // state
    let players = load(KS.players, []);
    let pitches = load(KS.pitches, []);

    // elements (scout-new area)
    const roleSeg = byId('roleSeg');
    const zoneSeg = byId('zoneSeg');
    const actionSeg = byId('actionSeg');
    const typeSeg = byId('pitchTypeSeg');
    const playerName = byId('playerName');
    const addPlayerBtn = byId('addPlayerBtn');
    const pitcherSelect = byId('pitcherSelect');
    const batterSelect = byId('batterSelect');
    const velo = byId('velo'), spin = byId('spin');
    const veloBox = byId('veloBox'), spinBox = byId('spinBox');
    const submitPitchBtn = byId('submitPitchBtn');
    const missPitchBtn = byId('missPitchBtn');
    const pitchTableBody = document.querySelector('#pitchTable tbody');
    const countHint = byId('countHint');

    const submitEventOpenBtn = byId('submitEventOpenBtn');
    const eventSection = byId('eventSection');
    const eventDate = byId('eventDate');
    const scoutName = byId('scoutName');
    const eventName = byId('eventName');
    const eventLocation = byId('eventLocation');
    const finalSubmitBtn = byId('finalSubmitBtn');
    const eventMsg = byId('eventMsg');

    // segment buttons
    function setActive(seg,btn){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); if(btn) btn.classList.add('active'); }
    function clearActive(seg){ seg.querySelectorAll('button').forEach(b=>b.classList.remove('active')); }
    roleSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(roleSeg, e.target); });
    zoneSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(zoneSeg, e.target); });
    actionSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(actionSeg, e.target); });
    typeSeg.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON') setActive(typeSeg, e.target); });
    roleSeg.querySelector('button[data-role="batter"]').classList.add('active');

    // slider <-> input sync
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function sliderToBox(){ veloBox.value = (Number(velo.value)===0 ? '' : String(velo.value)); spinBox.value = (Number(spin.value)===0 ? '' : String(spin.value)); }
    function commitVelo(){ const v=veloBox.value.trim(); velo.value = (v===''||v.toUpperCase()==='NA') ? 0 : clamp(parseInt(v)||0,0,105); sliderToBox(); }
    function commitSpin(){ const v=spinBox.value.trim(); spin.value = (v===''||v.toUpperCase()==='NA') ? 0 : clamp(parseInt(v)||0,0,4000); sliderToBox(); }
    velo.addEventListener('input', sliderToBox); spin.addEventListener('input', sliderToBox);
    veloBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commitVelo(); veloBox.blur(); }}); veloBox.addEventListener('change', commitVelo);
    spinBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commitSpin(); spinBox.blur(); }}); spinBox.addEventListener('change', commitSpin);
    sliderToBox();

    // players
    function refreshSelects(){
      pitcherSelect.innerHTML=''; batterSelect.innerHTML='';
      const pitchers = players.filter(p=>p.role==='pitcher'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const batters  = players.filter(p=>p.role==='batter'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const addOption=(sel, txt)=>{ const o=document.createElement('option'); o.text=txt; o.value=txt; sel.add(o); };
      if(!pitchers.length) addOption(pitcherSelect,'— add a Pitcher —'); pitchers.forEach(n=>addOption(pitcherSelect,n));
      if(!batters.length)  addOption(batterSelect,'— add a Hitter —');  batters.forEach(n=>addOption(batterSelect,n));
    }
    function addPlayer(){
      const name=(playerName.value||'').trim();
      const role=roleSeg.querySelector('.active')?.dataset.role||'batter';
      if(!name){ alert('Enter "Last, First"'); return; }
      players.push({name,role}); save(KS.players,players); playerName.value=''; refreshSelects();
    }
    addPlayerBtn.addEventListener('click', addPlayer);

    // utilities
    function getActiveVal(seg){ const b=seg.querySelector('button.active'); return b ? (b.dataset.val || b.dataset.role) : ''; }
    function resetPitchForm(){ clearActive(zoneSeg); clearActive(actionSeg); clearActive(typeSeg); velo.value=0; spin.value=0; sliderToBox(); }

    // table render/edit/delete
    function renderTable(){
      pitchTableBody.innerHTML='';
      pitches.forEach((r,idx)=>{
        const tr=document.createElement('tr'); tr.dataset.index=idx;
        tr.innerHTML = `
          <td>${r.time||''}</td><td>${r.pitcher||''}</td><td>${r.hitter||''}</td>
          <td>${r.zone||''}</td><td>${r.action||''}</td><td>${r.pitchType||''}</td>
          <td>${r.velo??''}</td><td>${r.spin??''}</td>
          <td><div class="cell-actions">
            <button class="icon-btn edit-btn" title="Edit row"><svg width="18" height="18"><use href="#ico-edit"/></svg></button>
            <button class="icon-btn del-btn" title="Delete"><svg width="18" height="18"><use href="#ico-x"/></svg></button>
          </div></td>`;
        pitchTableBody.appendChild(tr);
      });
      countHint.textContent = `${pitches.length} ${pitches.length===1?'pitch':'pitches'}`;
    }

    const ACTIONS=['TAKE','S/M','FOUL','BIP','HBP'], PITCH_TYPES=['FB','CB','SL','CH','SF','SI','OTHER'], ZONES=['IN','OUT'];
    function makeSelect(options,val){ const sel=document.createElement('select'); sel.className='cell-select'; const empty=document.createElement('option'); empty.value=''; empty.textContent=''; sel.appendChild(empty); options.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; sel.appendChild(op); }); return sel; }
    function makeInput(val){ const i=document.createElement('input'); i.type='text'; i.className='cell-input'; i.value=(val??''); return i; }
    function makePlayerSelect(list,current){ const sel=document.createElement('select'); sel.className='cell-select'; const set=new Set(list); if(current && !set.has(current)) list=[current,...list]; const empty=document.createElement('option'); empty.value=''; empty.textContent=''; sel.appendChild(empty); list.forEach(name=>{ const op=document.createElement('option'); op.value=name; op.textContent=name; if(name===current) op.selected=true; sel.appendChild(op); }); return sel; }

    document.querySelector('#pitchTable tbody').addEventListener('click', (e)=>{
      const del=e.target.closest('.del-btn');
      if(del){ const tr=e.target.closest('tr'); const idx=Number(tr.dataset.index); if(confirm('Delete this pitch?')){ pitches.splice(idx,1); save(KS.pitches,pitches); renderTable(); } return; }
      const btn=e.target.closest('.edit-btn'); if(!btn) return; const tr=e.target.closest('tr'); const idx=Number(tr.dataset.index); const r=pitches[idx]; if(tr.classList.contains('editing')) return; tr.classList.add('editing');
      const tds=tr.querySelectorAll('td'); const tdPitcher=tds[1], tdHitter=tds[2], tdZone=tds[3], tdAction=tds[4], tdType=tds[5], tdVelo=tds[6], tdSpin=tds[7], tdEdit=tds[8];
      const pitchers=players.filter(p=>p.role==='pitcher'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const batters=players.filter(p=>p.role==='batter'||p.role==='dual').map(p=>p.name).sort((a,b)=>a.localeCompare(b));
      const selZone=makeSelect(ZONES,r.zone||''); const selAction=makeSelect(ACTIONS,r.action||''); const selType=makeSelect(PITCH_TYPES,r.pitchType||''); const selPitcher=makePlayerSelect(pitchers,r.pitcher||''); const selHitter=makePlayerSelect(batters,r.hitter||''); const inVelo=makeInput(r.velo); const inSpin=makeInput(r.spin);
      tdPitcher.innerHTML=''; tdPitcher.appendChild(selPitcher); tdHitter.innerHTML=''; tdHitter.appendChild(selHitter); tdZone.innerHTML=''; tdZone.appendChild(selZone); tdAction.innerHTML=''; tdAction.appendChild(selAction); tdType.innerHTML=''; tdType.appendChild(selType); tdVelo.innerHTML=''; tdVelo.appendChild(inVelo); tdSpin.innerHTML=''; tdSpin.appendChild(inSpin);
      tdEdit.innerHTML=''; const saveBtn=document.createElement('button'); saveBtn.className='icon-btn'; saveBtn.title='Save'; saveBtn.innerHTML='<svg width="18" height="18"><use href="#ico-check"/></svg>'; const cancelBtn=document.createElement('button'); cancelBtn.className='icon-btn'; cancelBtn.title='Cancel'; cancelBtn.innerHTML='<svg width="18" height="18"><use href="#ico-x"/></svg>'; tdEdit.appendChild(saveBtn); tdEdit.appendChild(cancelBtn);
      saveBtn.addEventListener('click', ()=>{ r.pitcher=selPitcher.value.trim(); r.hitter=selHitter.value.trim(); r.zone=selZone.value||''; r.action=selAction.value||''; r.pitchType=selType.value||''; r.velo=inVelo.value.trim(); r.spin=inSpin.value.trim(); save(KS.pitches,pitches); tr.classList.remove('editing'); renderTable(); });
      cancelBtn.addEventListener('click', ()=>{ tr.classList.remove('editing'); renderTable(); });
    });

    function getSelections(){
      const pitcher=pitcherSelect.value, hitter=batterSelect.value;
      if(!pitcher || pitcher.startsWith('—')){ alert('Select a PITCHER.'); return null; }
      if(!hitter  || hitter.startsWith('—')){ alert('Select a HITTER.');  return null; }
      return {pitcher,hitter};
    }
    function submitPitch(){
      const sel=getSelections(); if(!sel) return;
      const row = {
        time: nowStamp(),
        pitcher: sel.pitcher,
        hitter: sel.hitter,
        zone: getActiveVal(zoneSeg)||'',
        action: getActiveVal(actionSeg)||'',
        pitchType: getActiveVal(typeSeg)||'',
        velo: Number(velo.value)||'',
        spin: Number(spin.value)||''
      };
      pitches.push(row); save(KS.pitches,pitches); renderTable(); submitPitchBtn.textContent='Logged ✓'; setTimeout(()=> submitPitchBtn.textContent='Submit Pitch',500); resetPitchForm();
    }
    function missPitch(){
      const sel=getSelections(); if(!sel) return;
      const row = { time: nowStamp(), pitcher: sel.pitcher, hitter: sel.hitter, zone:'', action:'', pitchType:'', velo:'', spin:'' };
      pitches.push(row); save(KS.pitches,pitches); renderTable(); missPitchBtn.textContent='Miss Logged ✓'; setTimeout(()=> missPitchBtn.textContent='Miss Pitch',500); resetPitchForm();
    }
    submitPitchBtn.addEventListener('click', submitPitch);
    missPitchBtn.addEventListener('click', missPitch);

    // event submit flow (creates an "event" object from current pitches)
    submitEventOpenBtn.addEventListener('click', ()=>{
      eventSection.classList.remove('hidden');
      eventDate.value = todayMDY();
      eventMsg.innerHTML = '';
      scoutName.value = session.fullName || session.username || '';
      eventSection.scrollIntoView({ behavior:'smooth' });
    });

    finalSubmitBtn.addEventListener('click', ()=>{
      const name=(eventName.value||'').trim();
      const location=(eventLocation.value||'').trim();
      if(!name){ alert('Enter Event Name'); return; }
      if(pitches.length===0){ alert('No pitches logged'); return; }

      // create and save event
      const ev = {
        id: Date.now(), // simple id
        date: eventDate.value || todayMDY(),
        scout: scoutName.value || session.username,
        name, location,
        pitches: pitches.slice()
      };
      const events = load(KS.events, []);
      events.push(ev); save(KS.events, events);

      // clear logger state
      pitches = []; players = [];
      save(KS.pitches, pitches); save(KS.players, players);
      refreshSelects(); renderTable();

      // UX
      eventMsg.innerHTML = '<div class="success">Event submitted. Log and players cleared.</div>';
      setTimeout(()=>{ eventSection.classList.add('hidden'); eventName.value=''; eventLocation.value=''; }, 1000);

      // update history if scout
      const s=loadSession(); if(s?.role==='scout'){ renderScoutEvents(); }
    });

    // first paint
    refreshSelects(); renderTable();
  }

  // CSV download for an event
  function downloadEventCSV(ev){
    const lines = [];
    lines.push(`Date,${csv(ev.date)},Scout,${csv(ev.scout)}`);
    lines.push(`Event,${csv(ev.name)},Location,${csv(ev.location)}`);
    lines.push('');
    lines.push('Time,Pitcher,Hitter,Zone,Action,Pitch Type,Velo,Spin');
    (ev.pitches||[]).forEach(p=>{
      lines.push([
        csv(p.time), csv(p.pitcher), csv(p.hitter),
        csv(p.zone), csv(p.action), csv(p.pitchType),
        csv(p.velo), csv(p.spin)
      ].join(','));
    });
    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeName = (ev.name||'event').replace(/[^\w-]+/g,'_');
    a.href = url; a.download = `${safeName}_${ev.date}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function csv(v){ const s = (v==null?'':String(v)); if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`; return s; }

  // boot
  routeByRole(false);
})();
</script>
</body>
</html>
